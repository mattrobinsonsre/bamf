apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "bamf.fullname" . }}-api-config
  labels:
    {{- include "bamf.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
data:
  config.yaml: |
    # BAMF API Server Configuration
    # Generated by Helm chart

    log_level: {{ .Values.api.config.log_level | quote }}

    # Certificate lifetimes
    certificates:
      user_ttl_hours: {{ .Values.api.config.certificates.user_ttl_hours | default 12 }}
      agent_ttl_hours: {{ .Values.api.config.certificates.agent_ttl_hours | default 8760 }}
      bridge_ttl_hours: {{ .Values.api.config.certificates.bridge_ttl_hours | default 24 }}

    # Audit configuration
    audit:
      retention_days: {{ .Values.api.config.audit.retention_days }}

    # Redis URL (password injected via environment)
    redis_url: {{ include "bamf.redisUrl" . | quote }}

    # Bridge tunnel port â€” external port clients use to reach bridge tunnels
    bridge_tunnel_port: {{ .Values.gateway.ports.https | default 443 }}

    {{- if .Values.gateway.tunnelDomain }}
    # Tunnel domain for web app proxy (e.g., "tunnel.bamf.local")
    tunnel_domain: {{ .Values.gateway.tunnelDomain | quote }}
    {{- end }}

    # Bridge headless service for internal relay communication
    bridge_headless_service: {{ printf "%s-bridge-headless" (include "bamf.fullname" .) | quote }}

    # Authentication
    auth:
      local_enabled: {{ .Values.auth.local.enabled }}
      {{- if .Values.gateway.enabled }}
      {{- $port := int (.Values.gateway.ports.https | default 443) }}
      {{- if eq $port 443 }}
      callback_base_url: {{ printf "https://%s" .Values.gateway.hostname | quote }}
      {{- else }}
      callback_base_url: {{ printf "https://%s:%d" .Values.gateway.hostname $port | quote }}
      {{- end }}
      {{- else }}
      callback_base_url: {{ printf "%s://%s" (ternary "https" "http" .Values.ingress.external.tls) .Values.ingress.external.hostname | quote }}
      {{- end }}
      {{- if .Values.auth.sso.auth0.enabled }}
      sso:
        default_provider: {{ .Values.auth.sso.defaultProvider | quote }}
        oidc:
          - name: auth0
            issuer_url: {{ .Values.auth.sso.auth0.issuerUrl | quote }}
            client_id: {{ .Values.auth.sso.auth0.clientId | quote }}
      {{- end }}
